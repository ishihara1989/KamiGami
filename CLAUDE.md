# Claude Agent向けプロジェクトガイド

このファイルは、このプロジェクトで作業するClaude Agentが最初に読むべきドキュメントです。

## 🚨 重要: 作業開始前に必ず読むこと

このプロジェクトでの作業を開始する前に、以下のドキュメントを**必ず読んでください**：

1. **[docs/gameplay-specification.md](docs/gameplay-specification.md)** 🎮
   - 式神システムのゲームプレイ仕様
   - 実装すべき動作と制約
   - **新しい機能を追加する前に仕様を確認すること**

2. **[docs/neoforge-gotchas.md](docs/neoforge-gotchas.md)** ⚠️
   - NeoForge 1.21.10での開発時によくある間違いと注意点
   - 過去に引っかかったエラーとその解決方法
   - **新しい機能を実装する前に必ず確認すること**

3. **[docs/entity-implementation-guide.md](docs/entity-implementation-guide.md)** 🧩
   - エンティティ実装の完全な手順書
   - チェックリストとトラブルシューティング
   - **エンティティを追加する際は必ず読むこと**

4. **[docs/item-implementation-guide.md](docs/item-implementation-guide.md)** 📦
   - アイテム実装の完全な手順書
   - チェックリストとトラブルシューティング
   - **アイテムを追加する際は必ず読むこと（特にItem Model Definitionファイル！）**

5. **[docs/project-structure.md](docs/project-structure.md)** 📁
   - プロジェクトのディレクトリ構造
   - ファイル命名規則
   - 新しいファイルを作成する前に確認すること

## 📝 ドキュメント更新のルール

### 新しい問題や解決策を見つけたら

開発中に以下のような状況に遭遇した場合、**必ずドキュメントを更新してください**：

1. **コンパイルエラーが発生した**
   - エラーメッセージ
   - 原因
   - 解決方法
   - → `docs/neoforge-gotchas.md` に追記

2. **予期しない動作や仕様変更を発見した**
   - バージョン情報
   - 以前の動作
   - 新しい動作
   - 対応方法
   - → `docs/neoforge-gotchas.md` に追記

3. **新しい種類の機能を実装した**
   - 実装手順
   - 注意点
   - コード例
   - → 新しいガイドファイルを作成するか、既存のドキュメントに追記

4. **ファイル構造やパターンを変更した**
   - 変更理由
   - 新しい構造
   - → `docs/project-structure.md` を更新

### ドキュメント更新のフォーマット

```markdown
## [機能名/問題名]

**発生日/更新日:** YYYY-MM-DD

**問題:**
[何が起きたか、または何を実装したか]

**原因:**
[なぜそうなったか]

**解決方法:**
[どうやって解決したか]

**コード例:**
```java
// 間違った例
❌ code here

// 正しい例
✅ code here
```

**参考リンク:**
- [関連ドキュメント]
```

## 🏗️ プロジェクト概要

### 基本情報
- **Mod名:** KamiGami
- **Minecraft バージョン:** 1.21.10
- **NeoForge バージョン:** 21.10.43-beta
- **Java バージョン:** 21
- **Mod ID:** `kamigami`
- **パッケージ:** `com.hydryhydra.kamigami`

### 開発環境
- **IDE:** IntelliJ IDEA / Eclipse / VS Code
- **ビルドツール:** Gradle 9.1.0
- **VCS:** Git

### プロジェクトの目標
式神（しきがみ）をテーマにしたMinecraft Modの開発。
紙で作られた召喚可能なエンティティを実装する。

**ゲームプレイの核心:**
- 低HPだが再利用可能な召喚生物
- 繁殖不可、発情モードなし
- 倒すと召喚アイテムをドロップ（リサイクル可能）
- バニラと同様の資源取得（ミルク、卵、羊毛など）

詳細は [docs/gameplay-specification.md](docs/gameplay-specification.md) を参照。

## 📂 プロジェクト構造の概要

```
KamiGami/
├── src/main/java/com/hydryhydra/kamigami/
│   ├── KamiGami.java          # メインModクラス
│   ├── entity/                # エンティティクラス
│   ├── item/                  # アイテムクラス
│   ├── block/                 # ブロッククラス
│   └── client/                # クライアント専用コード
├── src/main/resources/
│   ├── assets/kamigami/       # クライアント側リソース
│   └── data/kamigami/         # サーバー側データ
├── docs/                      # 開発ドキュメント（重要！）
└── CLAUDE.md                  # このファイル
```

詳細は [docs/project-structure.md](docs/project-structure.md) を参照。

## ✅ 実装済み機能

### 式神システム v1.0

#### 共通仕様
- **繁殖不可**: `BreedGoal`なし、`getBreedOffspring()`は`null`を返す
- **リサイクル**: 倒すと召喚アイテムをドロップ（Loot Table設定済み）
- **召喚**: 右クリックで召喚、クリエイティブでは消費されない
- **スタック**: 召喚アイテムは最大16個

#### 実装済みエンティティ
- **紙の牛 (Paper Cow)** - HP: 6.0 (3ハート)、ミルク取得可能
- **紙の鶏 (Paper Chicken)** - HP: 4.0 (2ハート)、卵を産む
- **紙の羊 (Paper Sheep)** - HP: 5.0 (2.5ハート)、羊毛刈り取り可能

詳細は [docs/gameplay-specification.md](docs/gameplay-specification.md) 参照。

#### リソース状態
- ✅ Javaクラス: 完成（3種の式神、召喚アイテム）
- ✅ エンティティテクスチャ: 完成
- ✅ アイテムテクスチャ: 完成
- ✅ 翻訳ファイル: 完成（英語、日本語）
- ✅ ルートテーブル: 完成（召喚アイテムドロップ）
- ✅ ゲームプレイ仕様: ドキュメント化完了

---

### 祠システム (Shrine System) 🆕

#### 実装済み機能
- **祠ブロック (ShrineBlock)**
  - アイテム保管機能（1スロット）
  - 右クリックでアイテムを入れる/取り出す
  - 向き調整機能（スニーク設置で180度回転）
  - **シルクタッチなしで破壊時に祟りスライムを召喚**

- **祟りスライム (TatariSlimeEntity)**
  - 黒いスライム型の敵対モンスター（イカスミパーティクル）
  - サイズ2（HP: 16、攻撃力: 4）で初期召喚
  - 倒すとサイズ1（HP: 4、攻撃力: 2）×2体に分裂
  - サイズ1を倒すとスライムボールまたはインクをドロップ
  - **詳細なログ実装済み**（サイズ、HP、攻撃力、分裂など）

#### リソース状態
- ✅ Javaクラス: 完成
- ✅ ブロックテクスチャ: 完成（祠本体・屋根）
- ✅ エンティティテクスチャ: 完成（祟りスライム）
- ✅ BlockEntityレンダラー: 実装済み
- ✅ 翻訳ファイル: 完成（英語、日本語）

#### 既知の問題と要調査項目
1. **祟りスライムの分裂動作**: 実際にゲーム内で分裂が正しく動作するか要確認
2. **祠の破壊時召喚**: シルクタッチの判定が正しく動作するか要確認
3. **BlockEntityの同期**: クライアント側でアイテムレンダリングが正しく動作するか要確認

## 🎯 当面の開発目標

### 優先度: 高 - 祠システムの検証と充実

1. **祠システムの動作確認** 🔍
   - 祟りスライムの召喚・分裂動作の検証
   - シルクタッチ判定の検証
   - BlockEntityの同期確認
   - **人間によるテストプレイを依頼することを躊躇しない**

2. **祠システムのギミック拡張** 🎮
   - 祠へのお供え物システム
   - お供え物に応じた効果（バフ、デバフ、召喚など）
   - 複数の祠を組み合わせた特殊効果
   - 祠の破壊ペナルティの調整

3. **バランス調整** ⚖️
   - 祟りスライムの強さ調整
   - 祠の入手難易度調整（クラフトレシピ、自然生成など）
   - お供え物のコスト・リターン調整

### 優先度: 中 - 式神システムの拡張

4. **新しい式神の追加** （必要に応じて）
   - 紙の豚、紙のウサギなど
   - 既存のパターンに従って実装
   - **必ず [docs/gameplay-specification.md](docs/gameplay-specification.md) のチェックリストを使用**

5. **クラフトレシピの追加**
   - 式神召喚アイテムのクラフトレシピ
   - 祠のクラフトレシピ
   - 式神コアアイテム（材料アイテム）

### 優先度: 低 - 将来の拡張

6. **ワールド生成**
   - 祠の自然生成
   - 遺跡やダンジョンへの配置

7. **高度な機能**
   - 式神の強化システム
   - 祠のネットワークシステム

## 🔧 よく使うGradleコマンド

### Windows環境
```bash
# コンパイル
.\gradlew.bat compileJava

# クライアント起動
.\gradlew.bat runClient

# サーバー起動
.\gradlew.bat runServer

# ビルド
.\gradlew.bat build

# コードフォーマット（チェックのみ）
.\gradlew.bat spotlessCheck

# コードフォーマット（自動修正）
.\gradlew.bat spotlessApply
```

### Linux/Mac環境
```bash
# コンパイル
./gradlew compileJava

# クライアント起動
./gradlew runClient

# その他も同様（.batを除く）
```

## 🐛 デバッグとトラブルシューティング

### 基本原則: 調査を入念に行う 🔍

問題が発生した場合、**修正前に必ず以下の調査を行うこと**：

1. **ログを確認する**
   - `logs/latest.log` を必ず確認
   - エラーメッセージやスタックトレースを読む
   - 既にログが仕込まれている箇所の出力を確認

2. **Web検索を活用する**
   - エラーメッセージで検索
   - NeoForge公式ドキュメントで検索
   - 類似の実装例を探す

3. **ログが不足している場合は追加する**
   - 重要なイベント発生時にログを出力
   - 変数の値やオブジェクトの状態を記録
   - ログ追加後に人間にテストプレイを依頼

4. **人間によるテストプレイを依頼することを躊躇しない**
   - 実行時の動作確認が必要な場合は遠慮なく依頼
   - ログを仕込んでから依頼すると効率的

### ログ記録のベストプラクティス

#### ログレベルの使い分け
```java
// 重大なエラー（ゲームプレイに影響）
KamiGami.LOGGER.error("Failed to spawn TatariSlime: {}", reason);

// 警告（期待しない動作だが続行可能）
KamiGami.LOGGER.warn("Shrine BlockEntity not found at position: {}", pos);

// 情報（重要なイベントの記録）
KamiGami.LOGGER.info("TatariSlime spawned with size: {}, HP: {}", size, hp);

// デバッグ（詳細な内部状態）
KamiGami.LOGGER.debug("Processing shrine interaction: player={}, item={}", player, item);
```

#### 良いログの例
```java
// ✅ 良い例: 重要な情報が全て含まれる
KamiGami.LOGGER.info("TatariSlime setSize() - Size set to: {}, HP: {}, Attack: {}",
    clampedSize, this.getMaxHealth(), this.getAttributeValue(Attributes.ATTACK_DAMAGE));

// ✅ 良い例: 分岐条件と結果が明確
KamiGami.LOGGER.info("TatariSlime splitting into {} slimes of size {}", splitCount, newSize);

// ❌ 悪い例: 情報不足
KamiGami.LOGGER.info("Slime created");
```

#### ログを入れるべき場所
- エンティティの初期化時（`finalizeSpawn`, `setSize`など）
- 重要なイベント（分裂、召喚、破壊など）
- NBTのロード・セーブ
- 予期しない状態や条件分岐
- エラーハンドリング

### コンパイルエラーが出たら
1. まず `docs/neoforge-gotchas.md` で同様のエラーを検索
2. エラーメッセージをよく読む（日本語で出力される場合あり）
3. NeoForge 1.21.10の仕様変更を疑う
4. 解決したら必ずドキュメントに追記

### ゲームがクラッシュしたら
1. **まずログファイルを確認**（`logs/latest.log`）
2. スタックトレースから原因箇所を特定
3. よくある原因：
   - エンティティ属性の登録忘れ
   - レンダラーの登録忘れ
   - リソースファイルの不一致
   - null参照
4. `docs/entity-implementation-guide.md` のチェックリストを確認
5. 原因が不明な場合は、該当箇所にログを追加してテストプレイを依頼

### 実行時の不具合が発生したら
1. **既存のログを確認**（多くの重要箇所にログが実装済み）
2. ログが不足している場合は**追加する**
3. **人間にテストプレイを依頼**してログを取得
4. ログを分析して原因を特定
5. 修正後、再度テストプレイを依頼して検証
6. **修正内容と調査結果をドキュメントに記録**

### テクスチャが表示されない
1. ファイルパスを確認
2. ファイル名が小文字+アンダースコアのみか確認
3. 登録名とファイル名が一致しているか確認
4. 詳細は `docs/project-structure.md` 参照

## 📚 外部リソース

- [NeoForge Documentation](https://docs.neoforged.net/)
- [NeoForge Discord](https://discord.neoforged.net/)
- [Minecraft Wiki](https://minecraft.wiki/)
- [NeoForge GitHub](https://github.com/neoforged/NeoForge)

## 🤝 コーディング規約

### Javaコード
- インデント: 4スペース
- 波括弧: Javaの標準スタイル
- 命名:
  - クラス: `PascalCase`
  - メソッド/変数: `camelCase`
  - 定数: `SCREAMING_SNAKE_CASE`
  - パッケージ: `lowercase`

### リソースファイル
- ファイル名: `snake_case` (小文字+アンダースコア)
- JSON: 2スペースインデント
- 登録名とファイル名を必ず一致させる

### コメント
- 複雑なロジックには説明コメントを追加
- パブリックメソッドにはJavadocを推奨
- 英語または日本語（プロジェクトで統一）

## ⚠️ 絶対にやってはいけないこと

1. **ドキュメントを読まずに実装を開始する**
   - 必ず `docs/neoforge-gotchas.md` を読んでから始める

2. **エラーを解決してドキュメントを更新しない**
   - 次のAgentが同じ問題で時間を無駄にします

3. **命名規則を無視する**
   - 大文字やハイフンを使わない
   - 必ず `snake_case` を使う

4. **テストせずにコミットする**
   - 少なくともコンパイルは通すこと

5. **既存のコードパターンを無視する**
   - 新しい機能は既存のパターンに従って実装

## 📊 作業フロー

新しいタスクを開始する際の推奨フロー：

```
1. このファイル（CLAUDE.md）を読む
   ↓
2. 関連するdocs/内のドキュメントを読む
   ↓
3. 既存のコードパターンを確認
   ↓
4. 実装を開始
   ↓
5. コンパイルしてテスト
   ↓
6. 問題があればドキュメントを確認
   ↓
7. 新しい発見があればドキュメントを更新
   ↓
8. 完了報告
```

## 🔄 定期的に確認すること

- [ ] ドキュメントが最新か
- [ ] 新しいエラーや解決策を追記したか
- [ ] コード例が正しく動作するか
- [ ] リンクが切れていないか

## 📞 質問や不明点があるとき

1. まず関連ドキュメントを確認
2. コードベース内の類似実装を検索
3. NeoForge公式ドキュメントを確認
4. それでも解決しない場合はユーザーに質問

---

## 📝 変更履歴

### 2025-01-05
- CLAUDE.md作成
- 初期ドキュメント整備完了
- 式神システム v1.0 実装完了

### 2025-11-06
- 日本語翻訳ファイル (`ja_jp.json`) を追加

### 2025-11-07
- **紙の羊 (Paper Sheep) 実装完了**
  - ハサミで羊毛刈り取り機能
  - 草を食べて羊毛再生機能
- **ゲームプレイ仕様の修正と検証**
  - 全エンティティから `BreedGoal` を削除（繁殖・発情完全無効化）
  - Loot Tableの不一致を修正（`paper_sheep.json` から条件削除）
  - `PaperSheepEntity` のコンパイルエラー修正
- **ドキュメント整備**
  - `docs/gameplay-specification.md` 作成（ゲームプレイ仕様の完全ドキュメント化）
  - README.md、CLAUDE.md の更新
  - 実装チェックリストの追加

### 2025-11-08 (午前)
- **コードフォーマッティング環境の整備**
  - Spotless Gradleプラグインを導入
  - Java（Eclipse JDT Formatter）とJSON（Gson）の自動フォーマット設定
  - Git pre-commitフックの実装（コミット前に自動フォーマット）
  - Windows環境対応（.batスクリプト）
- **ドキュメント追加**
  - `docs/code-formatting.md` 作成（フォーマット使用方法の完全ガイド）

### 2025-11-08 (午後)
- **CLAUDE.mdの大幅な整理と更新**
  - 祠システム (Shrine System) の情報を追加
  - 祟りスライム (TatariSlimeEntity) の詳細を追加
  - 古くなったタスク候補を削除（テクスチャ作成など）
  - 開発目標を「祠システムの検証と充実」に更新
  - デバッグとログ記録の詳細なガイドラインを追加
  - 調査プロセスの重要性を強調
  - Windows環境向けのGradleコマンド例を追加

### 2025-11-09
- **リソースファイルの不足を修正**
  - `assets/kamigami/items/shikigami_core.json` を追加
  - `assets/kamigami/items/charm_of_swamp_deity.json` を追加
  - アイテムモデル定義ファイル（Item Model Definition）の不足により、これらのアイテムがゲーム内で正しく表示されない問題を修正
- **アイテム実装ガイドを独立したドキュメントに切り出し**
  - `docs/item-implementation-guide.md` を新規作成
  - アイテム実装の完全な手順書とチェックリストを提供
  - Item Model Definitionファイルの重要性を強調
  - `docs/neoforge-gotchas.md` から参照リンクを追加
  - CLAUDE.mdの「作業開始前に必ず読むこと」セクションに追加
  - **理由:** アイテム追加時にItem Model Definitionファイル（`items/`ディレクトリ）を忘れやすいため、独立したガイドとして目立つようにした

---

**最終更新日:** 2025-11-09
**更新者:** Claude Agent

---

## 次のAgent（あなた）へのメッセージ

このプロジェクトは継続的に成長していきます。あなたが遭遇した問題、発見した解決策、学んだベストプラクティスは、次のAgentにとって貴重な財産です。

**必ず、あなたの経験をドキュメントに残してください。**

そうすることで、このプロジェクトはより良いものになり、開発効率は向上し続けます。

ドキュメントを読み、ドキュメントを書き、ドキュメントを更新する。
これが、このプロジェクトで最も重要な習慣です。

頑張ってください！ 🚀
